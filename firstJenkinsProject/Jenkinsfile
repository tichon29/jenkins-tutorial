pipeline {
    agent any
    stages {
        stage('Build') {
            options {
                timeout(time: 10, unit: "SECONDS")
            }
            steps {
                echo "Go to sleep for 1s"
                sleep(time: 1, unit: "SECONDS")
                echo "awake"
                sh 'echo "Checking files"'
                sh '''
                    #!/bin/sh
                    ls -la
                    echo "Checking fit"
                    if (grep -rnw 'firstJenkinsProject/test' -e 'fit(') || (grep -rnw 'firstJenkinsProject/test' -e 'fdescribe(')
                    then
                        echo "Should fail"
                        exit 1
                    else
                        echo "We are clean"
                    fi
                    echo "end"
                '''
            }
        }
        stage('2nd Step') {
            steps {
                sh 'echo "Hello World"'
            }
        }
        // returns a list of changed files
        stage('Check all updates') {
            echo "Get list of updated files"
            String getChangedFilesList() {
                echo "inside Get Changed Files List"
                changedFiles = []
                for (changeLogSet in currentBuild.changeSets) {
                    for (entry in changeLogSet.getItems()) { // for each commit in the detected changes
                        for (file in entry.getAffectedFiles()) {
                            echo "Updated file is: "
                            echo file.getPath()
                            changedFiles.add(file.getPath()) // add changed file to list
                        }
                    }
                }
                return changedFiles
            }
            getChangedFilesList()
        }
    }
}
